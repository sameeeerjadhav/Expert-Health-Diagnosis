<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>User Details - Admin Panel</title>
    <link rel="stylesheet" href="css/style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>

<body class="theme-admin">
    <div class="app-container">
        <!-- Sidebar -->
        <aside class="sidebar" id="app-sidebar"></aside>

        <!-- Main Content -->
        <main class="main-content">
            <div class="top-bar">
                <div style="display: flex; align-items: center; gap: 1rem;">
                    <a href="admin-users.html" class="btn btn-outline" style="padding: 6px 12px;">
                        <i class="fas fa-arrow-left"></i> Back
                    </a>
                    <h1 class="page-title">User Details</h1>
                </div>
            </div>

            <!-- Profile Form -->
            <div class="card" style="max-width: 800px; margin: 0 auto;">
                <form id="admin-user-form">
                    <input type="hidden" id="userId">

                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1.5rem;">
                        <div class="form-group">
                            <label class="form-label">Full Name</label>
                            <input type="text" class="form-control" id="fullName" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Email</label>
                            <input type="email" class="form-control" id="email" disabled style="background: #f1f5f9;">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Phone</label>
                            <input type="tel" class="form-control" id="phone">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Address</label>
                            <input type="text" class="form-control" id="address">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Role</label>
                            <input type="text" class="form-control" id="role" disabled
                                style="background: #f1f5f9; font-weight: 600;">
                        </div>

                        <!-- Verification (Doctor only) -->
                        <div class="form-group" id="verified-group" style="display: none;">
                            <label class="form-label">Status</label>
                            <select id="isVerified" class="form-control">
                                <option value="true">Verified</option>
                                <option value="false">Unverified</option>
                            </select>
                        </div>
                    </div>

                    <!-- Patient Specific -->
                    <div id="patient-fields"
                        style="display: none; border-top: 1px solid #e2e8f0; margin-top: 2rem; padding-top: 1rem;">
                        <h3 style="margin-bottom: 1rem;">Patient Details</h3>
                        <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 1rem;">
                            <div class="form-group">
                                <label class="form-label">Age</label>
                                <input type="number" class="form-control" id="age">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Gender</label>
                                <select class="form-control" id="gender">
                                    <option value="">Select</option>
                                    <option value="Male">Male</option>
                                    <option value="Female">Female</option>
                                    <option value="Other">Other</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Blood Group</label>
                                <select class="form-control" id="bloodGroup">
                                    <option value="">Select</option>
                                    <option value="A+">A+</option>
                                    <option value="A-">A-</option>
                                    <option value="B+">B+</option>
                                    <option value="B-">B-</option>
                                    <option value="AB+">AB+</option>
                                    <option value="AB-">AB-</option>
                                    <option value="O+">O+</option>
                                    <option value="O-">O-</option>
                                </select>
                            </div>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Medical History</label>
                            <textarea class="form-control" id="medicalHistory" rows="3"></textarea>
                        </div>
                    </div>

                    <!-- Doctor Specific -->
                    <div id="doctor-fields"
                        style="display: none; border-top: 1px solid #e2e8f0; margin-top: 2rem; padding-top: 1rem;">
                        <h3 style="margin-bottom: 1rem;">Doctor Details</h3>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                            <div class="form-group">
                                <label class="form-label">Specialization</label>
                                <input type="text" class="form-control" id="specialization">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Experience</label>
                                <input type="text" class="form-control" id="experience" placeholder="e.g. 10 Years">
                            </div>
                        </div>
                    </div>

                    <div style="margin-top: 2rem; display: flex; gap: 1rem;">
                        <button type="submit" class="btn btn-primary" id="save-btn">Save Changes</button>
                    </div>
                </form>
            </div>
        </main>
    </div>

    <script src="js/sidebar.js"></script>
    <script>
        const API_BASE = 'http://localhost:8080/api';
        const token = localStorage.getItem('token');
        const urlParams = new URLSearchParams(window.location.search);
        const userId = urlParams.get('id');

        if (!token) window.location.href = 'index.html';
        if (!userId) {
            alert('No user specified');
            window.location.href = 'admin-users.html';
        }

        async function loadUser() {
            try {
                const response = await fetch(`${API_BASE}/admin/users/${userId}`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (!response.ok) throw new Error('Failed to fetch user');

                const user = await response.json();

                // Populate common fields
                document.getElementById('userId').value = user.id;
                document.getElementById('fullName').value = user.fullName || '';
                document.getElementById('email').value = user.email || '';
                document.getElementById('phone').value = user.phone || '';
                document.getElementById('address').value = user.address || '';
                document.getElementById('role').value = user.role;

                // Role Logic
                if (user.role === 'PATIENT') {
                    document.getElementById('patient-fields').style.display = 'block';
                    document.getElementById('age').value = user.age || '';
                    document.getElementById('gender').value = user.gender || '';
                    document.getElementById('bloodGroup').value = user.bloodGroup || '';
                    document.getElementById('medicalHistory').value = user.medicalHistory || '';
                } else if (user.role === 'DOCTOR') {
                    document.getElementById('doctor-fields').style.display = 'block';
                    document.getElementById('verified-group').style.display = 'block';
                    document.getElementById('specialization').value = user.specialization || '';
                    document.getElementById('experience').value = user.experience || '';
                    document.getElementById('isVerified').value = user.isVerified;
                }

            } catch (error) {
                console.error(error);
                alert('Error loading user details');
                window.location.href = 'admin-users.html';
            }
        }

        document.getElementById('admin-user-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const btn = document.getElementById('save-btn');
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Saving...';
            btn.disabled = true;

            const role = document.getElementById('role').value;
            const data = {
                fullName: document.getElementById('fullName').value,
                phone: document.getElementById('phone').value,
                address: document.getElementById('address').value,

                // Patient
                age: role === 'PATIENT' ? document.getElementById('age').value : null,
                gender: role === 'PATIENT' ? document.getElementById('gender').value : null,
                bloodGroup: role === 'PATIENT' ? document.getElementById('bloodGroup').value : null,
                medicalHistory: role === 'PATIENT' ? document.getElementById('medicalHistory').value : null,

                // Doctor
                specialization: role === 'DOCTOR' ? document.getElementById('specialization').value : null,
                experience: role === 'DOCTOR' ? document.getElementById('experience').value : null,
                isVerified: role === 'DOCTOR' ? document.getElementById('isVerified').value === 'true' : null
            };

            try {
                const response = await fetch(`${API_BASE}/admin/users/${userId}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify(data)
                });

                if (response.ok) {
                    alert('User updated successfully');
                    window.location.href = 'admin-users.html';
                } else {
                    alert('Failed to update user');
                }
            } catch (error) {
                console.error(error);
                alert('Error updating user');
            } finally {
                btn.innerHTML = 'Save Changes';
                btn.disabled = false;
            }
        });

        loadUser();
    </script>
</body>

</html>