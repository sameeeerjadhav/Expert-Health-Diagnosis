<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Specialists | Expert Health</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="css/style.css">

</head>

<body>

    <div class="app-container">
        <!-- Sidebar -->
        <aside class="sidebar" id="app-sidebar"></aside>

        <!-- Main Content -->
        <main class="main-content">
            <header class="top-bar">
                <div>
                    <h1 class="page-title">Find a Specialist</h1>
                    <p class="text-muted" id="context-text">Recommended based on your assessment.</p>
                </div>
                <div class="search-bar-container" style="flex: 1; max-width: 400px; position: relative;">
                    <i class="fas fa-search"
                        style="position: absolute; left: 15px; top: 50%; transform: translateY(-50%); color: var(--text-muted);"></i>
                    <input type="text" id="doctor-search" class="form-control"
                        placeholder="Search by name or specialty..."
                        style="padding-left: 40px; border-radius: var(--radius-lg);">
                </div>
            </header>

            <div class="doctors-grid" id="doctors-container">
                <!-- Loading -->
                <div style="grid-column: 1/-1; text-align: center; padding: 4rem;">
                    <i class="fas fa-spinner fa-spin" style="font-size: 2rem; color: var(--primary);"></i>
                </div>
            </div>
        </main>
    </div>

    <!-- Script Logic Inline for simplicity in this migration -->
    <script src="js/sidebar.js"></script>
    <script>
        const isLocalDev = window.location.hostname === 'localhost' && window.location.port !== '' && window.location.port !== '80';
        const API_BASE = isLocalDev ? 'http://localhost:8080/api' : '/api';
        const token = localStorage.getItem('token');
        const riskLevel = localStorage.getItem('lastRiskLevel') || 'Unknown';

        // Specialist Mapping Logic
        let recommendedSpecialty = '';
        let contextMessage = 'Browse our directory of verified specialists.';

        if (riskLevel === 'HIGH' || riskLevel === 'high') {
            recommendedSpecialty = 'Psychiatrist';
            contextMessage = 'Based on your High Risk assessment, we strongly recommend consulting a <strong class="text-primary">Psychiatrist</strong> for comprehensive care and medication management.';
        } else if (riskLevel === 'MODERATE' || riskLevel === 'moderate') {
            recommendedSpecialty = 'Clinical Psychologist';
            contextMessage = 'Based on your Moderate risk assessment, we recommend speaking with a <strong class="text-primary">Clinical Psychologist</strong> or Therapist for counseling.';
        } else if (riskLevel === 'LOW' || riskLevel === 'low') {
            recommendedSpecialty = 'Therapist';
            contextMessage = 'Your Assessment indicates a Low risk. A <strong class="text-primary">Therapist</strong> or Counselor can help you maintain your well-being.';
        }

        document.getElementById('context-text').innerHTML = contextMessage;

        function logout() { localStorage.removeItem('token'); window.location.href = 'auth.html'; }

        async function loadDoctors() {
            try {
                // Determine API endpoint parameter
                const apiRisk = (riskLevel && riskLevel !== 'Unknown') ? `?riskLevel=${riskLevel.toUpperCase()}` : '';
                const response = await fetch(`${API_BASE}/doctors/recommend${apiRisk}`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (response.ok) {
                    let doctors = await response.json();

                    // Frontend Sorting/Filtering to prioritize the recommended specialty
                    if (recommendedSpecialty) {
                        const exactMatches = doctors.filter(d =>
                            (d.user?.specialization || '').toLowerCase().includes(recommendedSpecialty.toLowerCase())
                        );

                        const others = doctors.filter(d =>
                            !(d.user?.specialization || '').toLowerCase().includes(recommendedSpecialty.toLowerCase())
                        );

                        // If we have exact matches, prioritize them. If not, maybe fallback to 'Therapist' or just show all
                        if (exactMatches.length > 0) {
                            doctors = [...exactMatches, ...others];
                        }
                    }

                    renderDoctors(doctors);
                } else {
                    document.getElementById('doctors-container').innerHTML = '<p style="grid-column: 1/-1; text-align: center;">No doctors found at the moment.</p>';
                }
            } catch (error) {
                console.error(error);
                document.getElementById('doctors-container').innerHTML = '<p class="text-danger" style="grid-column: 1/-1; text-align: center;">Failed to load specialist data.</p>';
            }
        }

        function renderDoctors(doctors) {
            const container = document.getElementById('doctors-container');
            container.innerHTML = '';

            if (doctors.length === 0) {
                container.innerHTML = '<p style="grid-column: 1/-1; text-align: center;">No specialists available.</p>';
                return;
            }

            doctors.forEach(doc => {
                const card = document.createElement('div');
                card.className = 'card doctor-card';
                const name = doc.user?.fullName || 'Dr. Unknown';
                const specialization = doc.user?.specialization || 'Therapist';
                const rating = doc.rating || 4.5;
                const userId = doc.user?.id || doc.id;

                // Highlight if it matches recommendation
                const isRecommended = recommendedSpecialty && specialization.toLowerCase().includes(recommendedSpecialty.toLowerCase());
                const badgeHtml = isRecommended ? `<div style="background: rgba(16, 185, 129, 0.1); color: #10b981; padding: 4px 8px; border-radius: 4px; font-size: 0.75rem; font-weight: 600; margin-bottom: 1rem;">Recommended Match</div>` : '';

                card.innerHTML = `
    ${badgeHtml}
    <div class="avatar-large" style="${isRecommended ? 'background: linear-gradient(135deg, #10b981, #059669); color: white; box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);' : ''}">
        <i class="fas fa-user-md"></i>
    </div>
    <h3 style="font-size: 1.1rem; margin-bottom: 0.25rem;">${name}</h3>
    <div class="text-primary" style="font-weight: 500; font-size: 0.9rem;">${specialization}</div>

    <div style="display: flex; gap: 5px; margin-bottom: 1.5rem;">
        <span class="tag-badge"><i class="fas fa-star text-warning"></i> ${rating.toFixed(1)}</span>
        <span class="tag-badge text-success">Available</span>
    </div>

    <button class="btn btn-primary" style="width: 100%; margin-bottom: 0.5rem;"
        onclick="connectDoctor(${userId}, '${name}')">
        <i class="fas fa-comment"></i> Message
    </button>
    <button class="btn btn-outline" style="width: 100%;" onclick="connectVideo(${userId}, '${name}')">
        <i class="fas fa-video"></i> Video Call
    </button>
    `;
                container.appendChild(card);
            });

            // Add search filtering logic
            document.getElementById('doctor-search').addEventListener('input', function (e) {
                const term = e.target.value.toLowerCase();
                const cards = container.querySelectorAll('.doctor-card');
                cards.forEach(c => {
                    const text = c.innerText.toLowerCase();
                    c.style.display = text.includes(term) ? 'flex' : 'none';
                });
            });
        }

        window.connectDoctor = (id, name) => {
            localStorage.setItem('chatRecipientId', id);
            localStorage.setItem('chatRecipientName', name);
            window.location.href = 'chat.html';
        }

        window.connectVideo = (id, name) => {
            localStorage.setItem('chatRecipientId', id);
            localStorage.setItem('chatRecipientName', name);
            window.location.href = 'video.html';
        }

        loadDoctors();
    </script>
</body>

</html>