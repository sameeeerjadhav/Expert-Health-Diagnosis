<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Manage Users - Admin Panel</title>
    <link rel="stylesheet" href="css/style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>

<body class="theme-admin">
    <div class="app-container">
        <!-- Sidebar -->
        <aside class="sidebar" id="app-sidebar"></aside>

        <!-- Main Content -->
        <main class="main-content">
            <div class="top-bar">
                <div style="display: flex; justify-content: space-between; align-items: center; width: 100%;">
                    <h1 class="page-title">User Management</h1>
                    <div style="display: flex; gap: 1rem;">
                        <button onclick="openCreateModal()" class="btn btn-primary" style="padding: 10px 20px;">
                            <i class="fas fa-plus"></i> Create User
                        </button>
                        <select id="roleFilter" class="form-control" style="width: 150px;">
                            <option value="">All Users</option>
                            <option value="PATIENT">Patients</option>
                            <option value="DOCTOR">Doctors</option>
                            <option value="ADMIN">Admins</option>
                        </select>
                    </div>
                </div>
            </div>

            <!-- Users Table -->
            <div class="card">
                <div class="table-container" style="overflow-x: auto;">
                    <table style="width: 100%; border-collapse: collapse;">
                        <thead>
                            <tr style="background: #f1f5f9; border-bottom: 2px solid #e2e8f0;">
                                <th style="padding: 12px; text-align: left;">ID</th>
                                <th style="padding: 12px; text-align: left;">Name</th>
                                <th style="padding: 12px; text-align: left;">Email</th>
                                <th style="padding: 12px; text-align: left;">Role</th>
                                <th style="padding: 12px; text-align: left;">Specialization</th>
                                <th style="padding: 12px; text-align: left;">Age/Gender</th>
                                <th style="padding: 12px; text-align: left;">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="usersTableBody">
                            <tr>
                                <td colspan="7" style="text-align: center; padding: 2rem;">Loading...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </main>

        <!-- Create User Modal -->
        <div id="createModal"
            style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 1000; align-items: center; justify-content: center;">
            <div class="card" style="width: 90%; max-width: 500px; margin: auto;">
                <h2 style="margin-bottom: 1.5rem;">Create New User</h2>
                <form id="createForm">
                    <div class="form-group">
                        <label class="form-label">Full Name</label>
                        <input type="text" class="form-control" id="createName" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Email</label>
                        <input type="email" class="form-control" id="createEmail" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Password</label>
                        <input type="password" class="form-control" id="createPassword" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Role</label>
                        <select class="form-control" id="createRole" onchange="toggleDoctorFields()" required>
                            <option value="PATIENT">Patient</option>
                            <option value="DOCTOR">Doctor</option>
                            <option value="ADMIN">Admin</option>
                        </select>
                    </div>

                    <!-- Doctor Specific -->
                    <div id="doctorFields" style="display: none;">
                        <div class="form-group">
                            <label class="form-label">Specialization</label>
                            <input type="text" class="form-control" id="createSpecialization">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Experience</label>
                            <input type="text" class="form-control" id="createExperience" placeholder="e.g. 5 Years">
                        </div>
                    </div>

                    <div style="display: flex; gap: 1rem; margin-top: 2rem;">
                        <button type="submit" class="btn btn-primary" id="create-btn" style="flex: 1;">Create
                            User</button>
                        <button type="button" onclick="closeCreateModal()" class="btn btn-outline"
                            style="flex: 1;">Cancel</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script src="js/sidebar.js"></script>
    <script>
        const API_BASE = 'http://localhost:8080/api';
        const token = localStorage.getItem('token');

        if (!token) window.location.href = 'index.html';

        async function loadUsers(role = '') {
            try {
                let url = `${API_BASE}/admin/users`;
                if (role) {
                    url = `${API_BASE}/admin/users/${role.toLowerCase()}s`;
                }

                const response = await fetch(url, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const users = await response.json();

                const tbody = document.getElementById('usersTableBody');
                if (users.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="7" style="text-align: center; padding: 2rem;">No users found</td></tr>';
                    return;
                }

                tbody.innerHTML = users.map(user => `
                    <tr style="border-bottom: 1px solid #e2e8f0;">
                        <td style="padding: 12px;">${user.id}</td>
                        <td style="padding: 12px; font-weight: 600;">${user.fullName}</td>
                        <td style="padding: 12px;">${user.email}</td>
                        <td style="padding: 12px;">
                            <span class="badge badge-${getRoleBadge(user.role)}">${user.role}</span>
                        </td>
                        <td style="padding: 12px;">${user.specialization || '-'}</td>
                        <td style="padding: 12px;">${user.age ? `${user.age}/${user.gender}` : '-'}</td>
                        <td style="padding: 12px;">
                            <button onclick="viewUser(${user.id})" class="btn btn-outline" style="padding: 4px 8px; font-size: 0.8rem; margin-right: 0.5rem;">
                                <i class="fas fa-eye"></i> View
                            </button>
                            <button onclick="deleteUser(${user.id})" class="btn btn-outline" style="padding: 4px 8px; font-size: 0.8rem; color: #ef4444; border-color: #ef4444;">
                                <i class="fas fa-trash"></i> Delete
                            </button>
                        </td>
                    </tr>
                `).join('');
            } catch (error) {
                console.error('Error loading users:', error);
                document.getElementById('usersTableBody').innerHTML =
                    '<tr><td colspan="7" style="text-align: center; padding: 2rem; color: #ef4444;">Error loading users</td></tr>';
            }
        }

        function getRoleBadge(role) {
            const badges = {
                'PATIENT': 'primary',
                'DOCTOR': 'success',
                'ADMIN': 'warning'
            };
            return badges[role] || 'secondary';
        }

        function viewUser(id) {
            window.location.href = `admin-user-details.html?id=${id}`;
        }



        // Create User Logic
        function openCreateModal() {
            document.getElementById('createModal').style.display = 'flex';
        }

        function closeCreateModal() {
            document.getElementById('createModal').style.display = 'none';
        }

        function toggleDoctorFields() {
            const role = document.getElementById('createRole').value;
            const docFields = document.getElementById('doctorFields');
            docFields.style.display = (role === 'DOCTOR') ? 'block' : 'none';
        }

        document.getElementById('createForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const btn = document.getElementById('create-btn');
            btn.disabled = true;
            btn.innerHTML = 'Creating...';

            const role = document.getElementById('createRole').value;
            const data = {
                fullName: document.getElementById('createName').value,
                email: document.getElementById('createEmail').value,
                password: document.getElementById('createPassword').value,
                role: role,
                specialization: (role === 'DOCTOR') ? document.getElementById('createSpecialization').value : null,
                experience: (role === 'DOCTOR') ? document.getElementById('createExperience').value : null
            };

            try {
                const response = await fetch(`${API_BASE}/admin/users`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify(data)
                });

                if (response.ok) {
                    alert('User created successfully');
                    closeCreateModal();
                    document.getElementById('createForm').reset();
                    toggleDoctorFields(); // Reset visibility
                    loadUsers(document.getElementById('roleFilter').value);
                } else {
                    const err = await response.json();
                    alert(err.message || 'Failed to create user');
                }
            } catch (error) {
                console.error(error);
                alert('Error creating user');
            } finally {
                btn.disabled = false;
                btn.innerHTML = 'Create User';
            }
        });

        async function deleteUser(id) {
            if (!confirm('Are you sure you want to delete this user? This action cannot be undone.')) return;

            try {
                const response = await fetch(`${API_BASE}/admin/users/${id}`, {
                    method: 'DELETE',
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (response.ok) {
                    alert('User deleted successfully');
                    loadUsers(document.getElementById('roleFilter').value);
                } else {
                    alert('Failed to delete user');
                }
            } catch (error) {
                console.error('Error deleting user:', error);
                alert('Error deleting user');
            }
        }

        function logout() {
            localStorage.clear();
            window.location.href = 'index.html';
        }

        // Event listeners
        document.getElementById('roleFilter').addEventListener('change', (e) => {
            loadUsers(e.target.value);
        });

        // Initialize
        loadUsers();

        // Add badge styles
        const style = document.createElement('style');
        style.textContent = `
            .badge { padding: 4px 8px; border-radius: 4px; font-size: 0.75rem; font-weight: 600; }
            .badge-primary { background: #dbeafe; color: #1e40af; }
            .badge-success { background: #d1fae5; color: #065f46; }
            .badge-warning { background: #fef3c7; color: #92400e; }
            .badge-secondary { background: #e2e8f0; color: #475569; }
            .table-container { max-height: 70vh; overflow-y: auto; }
        `;
        document.head.appendChild(style);
    </script>
</body>

</html>