<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Manage Appointments - Admin Panel</title>
    <link rel="stylesheet" href="css/style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>

<body class="theme-admin">
    <div class="app-container">
        <!-- Sidebar -->
        <aside class="sidebar" id="app-sidebar"></aside>

        <!-- Main Content -->
        <main class="main-content">
            <div class="top-bar">
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <h1 class="page-title">Appointment Management</h1>
                    <button onclick="openScheduleModal()" class="btn btn-primary" style="padding: 10px 20px;">
                        <i class="fas fa-plus"></i> Schedule Appointment
                    </button>
                </div>
            </div>

            <!-- Appointments Table -->
            <div class="card">
                <div class="table-container" style="overflow-x: auto;">
                    <table style="width: 100%; border-collapse: collapse;">
                        <thead>
                            <tr style="background: #f1f5f9; border-bottom: 2px solid #e2e8f0;">
                                <th style="padding: 12px; text-align: left;">ID</th>
                                <th style="padding: 12px; text-align: left;">Patient</th>
                                <th style="padding: 12px; text-align: left;">Doctor</th>
                                <th style="padding: 12px; text-align: left;">Date</th>
                                <th style="padding: 12px; text-align: left;">Time</th>
                                <th style="padding: 12px; text-align: left;">Status</th>
                                <th style="padding: 12px; text-align: left;">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="appointmentsTableBody">
                            <tr>
                                <td colspan="7" style="text-align: center; padding: 2rem;">Loading...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </main>

        <!-- Edit Modal -->
        <div id="editModal"
            style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 1000; align-items: center; justify-content: center;">
            <div class="card" style="width: 90%; max-width: 500px; margin: auto;">
                <h2 style="margin-bottom: 1.5rem;">Edit Appointment</h2>
                <form id="editForm">
                    <div class="form-group">
                        <label class="form-label">Date</label>
                        <input type="date" class="form-control" id="editDate" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Time Slot</label>
                        <select class="form-control" id="editTime" required>
                            <option value="9:00 AM - 9:30 AM">9:00 AM - 9:30 AM</option>
                            <option value="10:00 AM - 10:30 AM">10:00 AM - 10:30 AM</option>
                            <option value="11:00 AM - 11:30 AM">11:00 AM - 11:30 AM</option>
                            <option value="2:00 PM - 2:30 PM">2:00 PM - 2:30 PM</option>
                            <option value="3:00 PM - 3:30 PM">3:00 PM - 3:30 PM</option>
                            <option value="4:00 PM - 4:30 PM">4:00 PM - 4:30 PM</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Status</label>
                        <select class="form-control" id="editStatus" required>
                            <option value="PENDING">Pending</option>
                            <option value="CONFIRMED">Confirmed</option>
                            <option value="COMPLETED">Completed</option>
                            <option value="CANCELLED">Cancelled</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Notes</label>
                        <textarea class="form-control" id="editNotes" rows="2"></textarea>
                    </div>
                    <div style="display: flex; gap: 1rem; margin-top: 2rem;">
                        <button type="submit" class="btn btn-primary" id="save-btn" style="flex: 1;">Save
                            Changes</button>
                        <button type="button" onclick="closeEditModal()" class="btn btn-outline"
                            style="flex: 1;">Cancel</button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Schedule Modal -->
        <div id="scheduleModal"
            style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 1000; align-items: center; justify-content: center;">
            <div class="card" style="width: 90%; max-width: 500px; margin: auto;">
                <h2 style="margin-bottom: 1.5rem;">Schedule Appointment</h2>
                <form id="scheduleForm">
                    <div class="form-group">
                        <label class="form-label">Patient</label>
                        <select class="form-control" id="schedulePatient" required>
                            <option value="">Loading patients...</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Doctor</label>
                        <select class="form-control" id="scheduleDoctor" required>
                            <option value="">Loading doctors...</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Date</label>
                        <input type="date" class="form-control" id="scheduleDate" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Time Slot</label>
                        <select class="form-control" id="scheduleTime" required>
                            <option value="">Select Time</option>
                            <option value="9:00 AM - 9:30 AM">9:00 AM - 9:30 AM</option>
                            <option value="10:00 AM - 10:30 AM">10:00 AM - 10:30 AM</option>
                            <option value="11:00 AM - 11:30 AM">11:00 AM - 11:30 AM</option>
                            <option value="2:00 PM - 2:30 PM">2:00 PM - 2:30 PM</option>
                            <option value="3:00 PM - 3:30 PM">3:00 PM - 3:30 PM</option>
                            <option value="4:00 PM - 4:30 PM">4:00 PM - 4:30 PM</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Notes</label>
                        <textarea class="form-control" id="scheduleNotes" rows="2"></textarea>
                    </div>
                    <div style="display: flex; gap: 1rem; margin-top: 2rem;">
                        <button type="submit" class="btn btn-primary" id="schedule-btn" style="flex: 1;">Confirm
                            Schedule</button>
                        <button type="button" onclick="closeScheduleModal()" class="btn btn-outline"
                            style="flex: 1;">Cancel</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script src="js/sidebar.js"></script>
    <script>
        const API_BASE = 'http://localhost:8080/api';
        const token = localStorage.getItem('token');

        if (!token) window.location.href = 'index.html';

        async function loadAppointments() {
            try {
                const response = await fetch(`${API_BASE}/admin/appointments`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const appointments = await response.json();

                const tbody = document.getElementById('appointmentsTableBody');
                if (appointments.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="7" style="text-align: center; padding: 2rem;">No appointments found</td></tr>';
                    return;
                }

                tbody.innerHTML = appointments.map(apt => `
                    <tr style="border-bottom: 1px solid #e2e8f0;">
                        <td style="padding: 12px;">${apt.id}</td>
                        <td style="padding: 12px; font-weight: 600;">${apt.patient.fullName}</td>
                        <td style="padding: 12px;">${apt.doctor.fullName}</td>
                        <td style="padding: 12px;">${apt.appointmentDate}</td>
                        <td style="padding: 12px;">${apt.timeSlot}</td>
                        <td style="padding: 12px;">
                            <span class="badge badge-${getStatusBadge(apt.status)}">${apt.status}</span>
                        </td>
                        <td style="padding: 12px;">
                            <button onclick="editAppointment(${apt.id}, '${apt.appointmentDate}', '${apt.timeSlot}', '${apt.status}')" class="btn btn-outline" style="padding: 4px 8px; font-size: 0.8rem; margin-right: 0.5rem;">
                                <i class="fas fa-edit"></i> Edit
                            </button>
                            <button onclick="deleteAppointment(${apt.id})" class="btn btn-outline" style="padding: 4px 8px; font-size: 0.8rem; color: #ef4444; border-color: #ef4444;">
                                <i class="fas fa-trash"></i> Delete
                            </button>
                        </td>
                    </tr>
                `).join('');
            } catch (error) {
                console.error('Error loading appointments:', error);
                document.getElementById('appointmentsTableBody').innerHTML =
                    '<tr><td colspan="7" style="text-align: center; padding: 2rem; color: #ef4444;">Error loading appointments</td></tr>';
            }
        }

        function getStatusBadge(status) {
            const badges = {
                'PENDING': 'warning',
                'CONFIRMED': 'success',
                'COMPLETED': 'secondary',
                'CANCELLED': 'danger'
            };
            return badges[status] || 'secondary';
        }

        // Edit Logic
        let editingAptId = null;
        function editAppointment(id, date, time, status) {
            editingAptId = id;
            document.getElementById('editDate').value = date;

            // Handle time slot selection or free text
            const timeSelect = document.getElementById('editTime');
            // If the time exists in options, select it, else add it/handle it. 
            // For simplicity, we just set the value if it matches, or leave user to pick.
            // A better way is to make it a text input or ensuring standardized slots.
            // Let's assume standard slots for now.
            timeSelect.value = time;

            document.getElementById('editStatus').value = status;
            document.getElementById('editModal').style.display = 'flex';
        }

        function closeEditModal() {
            document.getElementById('editModal').style.display = 'none';
        }

        document.getElementById('editForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const btn = document.getElementById('save-btn');
            btn.disabled = true;
            btn.innerHTML = 'Saving...';

            const data = {
                appointmentDate: document.getElementById('editDate').value,
                timeSlot: document.getElementById('editTime').value,
                status: document.getElementById('editStatus').value,
                notes: document.getElementById('editNotes').value
            };

            try {
                const response = await fetch(`${API_BASE}/admin/appointments/${editingAptId}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify(data)
                });

                if (response.ok) {
                    alert('Appointment updated successfully');
                    closeEditModal();
                    loadAppointments();
                } else {
                    alert('Failed to update appointment');
                }
            } catch (error) {
                console.error(error);
                alert('Error updating appointment');
            } finally {
                btn.disabled = false;
                btn.innerHTML = 'Save Changes';
            }
        });

        async function deleteAppointment(id) {
            if (!confirm('Are you sure you want to delete this appointment?')) return;

            try {
                const response = await fetch(`${API_BASE}/admin/appointments/${id}`, {
                    method: 'DELETE',
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (response.ok) {
                    alert('Appointment deleted successfully');
                    loadAppointments();
                } else {
                    alert('Failed to delete appointment');
                }
            } catch (error) {
                console.error('Error deleting appointment:', error);
                alert('Error deleting appointment');
            }
        }

        function logout() {
            localStorage.clear();
            window.location.href = 'index.html';
        }

        // Schedule Logic
        function openScheduleModal() {
            document.getElementById('scheduleModal').style.display = 'flex';
            loadUsersForDropdowns();
        }

        function closeScheduleModal() {
            document.getElementById('scheduleModal').style.display = 'none';
        }

        async function loadUsersForDropdowns() {
            const patientSelect = document.getElementById('schedulePatient');
            const doctorSelect = document.getElementById('scheduleDoctor');

            // Prevent multiple loads if already loaded
            if (patientSelect.options.length > 1 && doctorSelect.options.length > 1) return;

            try {
                // Fetch Patients
                const patRes = await fetch(`${API_BASE}/admin/users/patients`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const patients = await patRes.json();
                patientSelect.innerHTML = '<option value="">Select Patient</option>' +
                    patients.map(p => `<option value="${p.id}">${p.fullName} (ID: ${p.id})</option>`).join('');

                // Fetch Doctors
                const docRes = await fetch(`${API_BASE}/admin/users/doctors`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const doctors = await docRes.json();
                doctorSelect.innerHTML = '<option value="">Select Doctor</option>' +
                    doctors.map(d => `<option value="${d.id}">${d.fullName} (ID: ${d.id})</option>`).join('');

            } catch (error) {
                console.error('Error loading users:', error);
                alert('Failed to load patients and doctors lists');
            }
        }

        document.getElementById('scheduleForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const btn = document.getElementById('schedule-btn');
            btn.disabled = true;
            btn.innerHTML = 'Scheduling...';

            const data = {
                patientId: document.getElementById('schedulePatient').value,
                doctorId: document.getElementById('scheduleDoctor').value,
                appointmentDate: document.getElementById('scheduleDate').value,
                timeSlot: document.getElementById('scheduleTime').value,
                notes: document.getElementById('scheduleNotes').value
            };

            try {
                const response = await fetch(`${API_BASE}/admin/appointments`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify(data)
                });

                if (response.ok) {
                    alert('Appointment scheduled successfully');
                    closeScheduleModal();
                    loadAppointments();
                    document.getElementById('scheduleForm').reset();
                } else {
                    alert('Failed to schedule appointment');
                }
            } catch (error) {
                console.error(error);
                alert('Error scheduling appointment');
            } finally {
                btn.disabled = false;
                btn.innerHTML = 'Confirm Schedule';
            }
        });

        // Initialize
        loadAppointments();

        // Add badge styles
        const style = document.createElement('style');
        style.textContent = `
            .badge { padding: 4px 8px; border-radius: 4px; font-size: 0.75rem; font-weight: 600; }
            .badge-warning { background: #fef3c7; color: #92400e; }
            .badge-success { background: #d1fae5; color: #065f46; }
            .badge-secondary { background: #e2e8f0; color: #475569; }
            .badge-danger { background: #fee2e2; color: #991b1b; }
            .table-container { max-height: 70vh; overflow-y: auto; }
        `;
        document.head.appendChild(style);
    </script>
</body>

</html>